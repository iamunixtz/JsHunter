{% extends "base.html" %}

{% block title %}Scan Results - Rezon{% endblock %}

{% block content %}
<div class="flex flex-between mb-3">
    <div>
        <h1>Scan Results</h1>
        <p>{{ scan.url or scan.filename or 'Code scan' }} - 
           <span class="badge {% if scan.status == 'completed' %}badge-success{% else %}badge-warning{% endif %}">
               {{ scan.status.title() }}
           </span>
        </p>
    </div>
    <div class="flex flex-gap">
        <a href="{{ url_for('project_detail', project_id=scan.project_id) }}" class="btn btn-outline">Back to Project</a>
        <div style="position: relative; display: inline-block;">
            <button class="btn" onclick="toggleExportMenu()">Export</button>
            <div id="exportMenu" class="hidden" style="position: absolute; top: 100%; right: 0; background: white; border: 2px solid black; min-width: 150px; z-index: 1000;">
                <a href="{{ url_for('export_scan_results', scan_id=scan.id, format='csv') }}" style="display: block; padding: 0.5rem 1rem; text-decoration: none; color: black; border-bottom: 1px solid black;">Export CSV</a>
                <a href="{{ url_for('export_scan_results', scan_id=scan.id, format='json') }}" style="display: block; padding: 0.5rem 1rem; text-decoration: none; color: black;">Export JSON</a>
            </div>
        </div>
    </div>
</div>

<!-- Summary -->
<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-number">{{ secrets|length }}</span>
        <div class="stat-label">Secrets Found</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ secrets|selectattr('severity', 'equalto', 'critical')|list|length }}</span>
        <div class="stat-label">Critical Issues</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ urls|length }}</span>
        <div class="stat-label">URLs Extracted</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ endpoints|length }}</span>
        <div class="stat-label">API Endpoints</div>
    </div>
</div>

<!-- Secrets Results -->
{% if secrets %}
<div class="card">
    <div class="card-header">Secrets Found ({{ secrets|length }})</div>
    <div class="card-body">
        {% for secret in secrets %}
        <div class="secret-item">
            <div class="secret-header">
                <div class="flex flex-between">
                    <strong>{{ secret.secret_type }}</strong>
                    <span class="badge {% if secret.severity == 'critical' %}badge-danger{% elif secret.severity == 'high' %}badge-warning{% else %}badge-info{% endif %}">
                        {{ secret.severity.upper() }}
                    </span>
                </div>
            </div>
            <div class="secret-body">
                <div class="mb-2">
                    <strong>Secret Value:</strong>
                    <div class="secret-value">{{ secret.secret_value }}</div>
                </div>
                
                {% if secret.line_number %}
                <div class="mb-2">
                    <strong>Line {{ secret.line_number }}:</strong>
                    <div class="secret-context">{{ secret.context }}</div>
                </div>
                {% endif %}
                
                {% if secret.source_url %}
                <div class="mb-2">
                    <strong>Source:</strong>
                    <a href="{{ secret.source_url }}" target="_blank">{{ secret.source_url }}</a>
                </div>
                {% endif %}
                
                <small>Found at {{ secret.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</small>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- URLs Results -->
{% if urls %}
<div class="card">
    <div class="card-header">URLs Extracted ({{ urls|length }})</div>
    <div class="card-body">
        <div class="grid grid-2">
            {% for url in urls %}
            <div style="padding: 0.5rem; background: #f5f5f5; border: 1px solid black; margin-bottom: 0.5rem;">
                <a href="{{ url.url }}" target="_blank">{{ url.url }}</a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- API Endpoints Results -->
{% if endpoints %}
<div class="card">
    <div class="card-header">API Endpoints ({{ endpoints|length }})</div>
    <div class="card-body">
        <div class="grid grid-2">
            {% for endpoint in endpoints %}
            <div style="padding: 0.5rem; background: #f5f5f5; border: 1px solid black; margin-bottom: 0.5rem;">
                <code>{{ endpoint.endpoint }}</code>
                {% if endpoint.source_url %}
                <br><small>From: {{ endpoint.source_url }}</small>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- No Results -->
{% if not secrets and not urls and not endpoints %}
<div class="card">
    <div class="card-body text-center">
        <h2>Clean Scan!</h2>
        <p>No secrets or sensitive data detected in this scan.</p>
    </div>
</div>
{% endif %}

<script>
function toggleExportMenu() {
    const menu = document.getElementById('exportMenu');
    menu.classList.toggle('hidden');
}

// Close export menu when clicking outside
document.addEventListener('click', function(event) {
    const menu = document.getElementById('exportMenu');
    const button = event.target.closest('button');
    if (!button || button.textContent !== 'Export') {
        menu.classList.add('hidden');
    }
});
</script>
{% endblock %}
