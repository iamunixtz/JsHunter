{% extends "base.html" %}

{% block title %}{{ project.name }} - Rezon{% endblock %}

{% block content %}
<div class="flex flex-between mb-3">
    <div>
        <h1>{{ project.name }}</h1>
        <p>{{ project.description or 'No description provided' }}</p>
        <small>Created {{ project.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
    </div>
    <div class="flex flex-gap">
        <a href="{{ url_for('projects') }}" class="btn btn-outline">All Projects</a>
        <a href="{{ url_for('scan', project_id=project.id) }}" class="btn">New Scan</a>
    </div>
</div>

<!-- Project Statistics -->
<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-number">{{ scans|length }}</span>
        <div class="stat-label">Total Scans</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">{{ scans|sum(attribute='total_secrets') }}</span>
        <div class="stat-label">Secrets Found</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">
            {% set critical_count = 0 %}
            {% for scan in scans %}
                {% for secret in scan.secrets %}
                    {% if secret.severity == 'critical' %}
                        {% set critical_count = critical_count + 1 %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            {{ critical_count }}
        </span>
        <div class="stat-label">Critical Issues</div>
    </div>
    <div class="stat-card">
        <span class="stat-number">
            {% set completed_scans = scans|selectattr('status', 'equalto', 'completed')|list|length %}
            {{ ((completed_scans / scans|length * 100) if scans|length > 0 else 0)|round|int }}%
        </span>
        <div class="stat-label">Success Rate</div>
    </div>
</div>

<!-- Scan History -->
<div class="card">
    <div class="card-header">Scan History</div>
    <div class="card-body">
        {% if scans %}
        <table class="table">
            <thead>
                <tr>
                    <th>Target</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Secrets</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for scan in scans %}
                <tr>
                    <td>{{ scan.url or scan.filename or 'Code Input' }}</td>
                    <td><span class="badge">{{ scan.scan_type.upper() }}</span></td>
                    <td>
                        <span class="badge {% if scan.status == 'completed' %}badge-success{% elif scan.status == 'failed' %}badge-danger{% else %}badge-warning{% endif %}">
                            {{ scan.status.title() }}
                        </span>
                    </td>
                    <td>
                        {% if scan.total_secrets > 0 %}
                            <span class="badge badge-warning">{{ scan.total_secrets }}</span>
                            {% set critical_count = scan.secrets|selectattr('severity', 'equalto', 'critical')|list|length %}
                            {% if critical_count > 0 %}
                                <span class="badge badge-danger">{{ critical_count }} critical</span>
                            {% endif %}
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td>{{ scan.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        {% if scan.status == 'completed' %}
                        <a href="{{ url_for('scan_results', scan_id=scan.id) }}" class="btn btn-outline">View</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="text-center">
            <h3>No Scans Yet</h3>
            <p>Start your first scan to see results here</p>
            <a href="{{ url_for('scan', project_id=project.id) }}" class="btn">Start First Scan</a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
